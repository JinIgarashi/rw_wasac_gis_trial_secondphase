/*
  gis.js -- Web GIS Library
  Copyright 2017 Jin Igarashi All Right Reserved.
*/
var gis={VERSION_NUMBER:"Release 1.0",singleFile:true,_getScriptLocation:(function(){var r=new RegExp("(^|(.*?\\/))(gis[^\\/]*?\\.js)(\\?|$)"),s=document.getElementsByTagName('script'),src,m,l="";for(var i=0,len=s.length;i<len;i++){src=s[i].getAttribute('src');if(src){m=src.match(r);if(m){l=m[1];break;}}}
return(function(){return l;});})()};gis.ui=function(spec,my){var that={};my=my||{};my.divid=spec.divid;that.CLASS_NAME="gis.ui";return that;};gis.ui.control=function(spec,my){my=my||{};var that=gis.ui(spec,my);my.map=spec.map;my.options=spec.options||{};my.notRequireSP=spec.notRequireSP||false;my.control=null;that.init=function(){};that.add=function(){if(my.control==null){return;}
if(gis.util.isSmartphone()==true&&my.notRequireSP==true){return;}
my.control.addTo(my.map);};that.CLASS_NAME="gis.ui.control";return that;};gis.ui.dialog=function(spec,my){my=my||{};var that=gis.ui(spec,my);my.divid=spec.divid;my.dialogId=spec.divid+'-dialog';my.isInit=false;my.getHtml=function(){return"";};my.beforeOpen=function(){};my.postCreate=function(){};my.addOptions=function(option){return option;};my.set_bounds=function(object){if(!object){my.selected_bounds=null;}
my.selected_bounds=[[object.ymin,object.xmin],[object.ymax,object.xmax]];my.map.flyToBounds(my.selected_bounds);}
that.create=function(option){option=option||{};if(my.isInit===true){return;}
$(document.body).append("<div id='"+my.dialogId+"'></div>");$("#"+my.dialogId).html(my.getHtml());option=my.addOptions(option);if(!option){option={};}
if(!option.autoOpen){option.autoOpen=false;}
if(!option.modal){option.modal=false;}
if(!option.position){option.position=[0,0];}
$("#"+my.dialogId).dialog(option);my.postCreate();};that.open=function(){$("#"+my.dialogId).dialog('open');};that.close=function(){$("#"+my.dialogId).dialog('close');};that.CLASS_NAME="gis.ui.dialog";return that;};gis.ui.controlLoader=function(spec,my){var that={};my=my||{};my.map=spec.map;my.defineurl=spec.defineurl;that.init=function(){$.ajax({url:my.defineurl,type:'GET',dataType:'json',cache:false,async:true}).done(function(ctrls_define){var settings={map:my.map};for(var i in ctrls_define){for(var j in ctrls_define[i].settings){settings[j]=ctrls_define[i].settings[j];}
var ctrl=gis.ui.control[ctrls_define[i].ctrl](settings);ctrl.init();ctrl.add();}});};that.CLASS_NAME="gis.ui.controlLoader";return that;};gis.ui.control.bookmarks=function(spec,my){my=my||{};var that=gis.ui.control(spec,my);my.url='./rest/Bookmarks/';my.storage={getItem:function(id,callback){gis.util.ajaxGet(my.url+id,callback);},setItem:function(id,value,callback){gis.util.ajaxPut(my.url+id,callback,value);},removeItem:function(id,callback){gis.util.ajaxDelete(my.url+id,callback);},getAllItems:function(callback){gis.util.ajaxGet(my.url,callback);}};my.options=spec.options||{};that.init=function(){my.options['storage']=my.storage;my.control=new L.Control.Bookmarks(my.options);};that.CLASS_NAME="gis.ui.control.bookmarks";return that;};gis.ui.control.navbar=function(spec,my){my=my||{};var that=gis.ui.control(spec,my);my.notRequireSP=spec.notRequireSP||true;that.init=function(){my.control=L.control.navbar(my.options);};that.CLASS_NAME="gis.ui.control.navbar";return that;};gis.ui.mapOptionCreator=function(spec,my){var that={};my=my||{};my.map=null;my.contextmenu=spec.contextmenu||true;my.contextmenuWidth=spec.contextmenuWidth||150;my.contextmenuItems=spec.contextmenuItems||[{text:'Show coordinates',icon:'css/leaflet/images/comment.png',callback:function(e){L.popup().setLatLng(e.latlng).setContent(e.latlng.lat+", "+e.latlng.lng).openOn(my.map);}},{text:'Center map here',icon:'css/leaflet/images/pan.png',callback:function(e){my.map.panTo(e.latlng);}},'-',{text:'Zoom in',icon:'css/leaflet/images/zoom-in.png',callback:function(e){my.map.zoomIn();}},{text:'Zoom out',icon:'css/leaflet/images/zoom-out.png',callback:function(e){my.map.zoomOut();}}];that.create=function(options){if(gis.util.isSmartphone()===true){options.zoomControl=false;}
options.contextmenu=my.contextmenu;options.contextmenuWidth=my.contextmenuWidth;options.contextmenuItems=my.contextmenuItems;return that;};that.bind=function(map){my.map=map;};that.CLASS_NAME="gis.ui.mapOptionCreator";return that;};gis.ui.control.graphicScale=function(spec,my){my=my||{};var that=gis.ui.control(spec,my);my.options=spec.options||{fill:'hollow',showSubunits:true,labelPlacement:'top'};my.notRequireSP=spec.notRequireSP||true;that.init=function(){my.control=L.control.graphicScale(my.options);};that.CLASS_NAME="gis.ui.control.graphicScale";return that;};gis.ui.control.locate=function(spec,my){my=my||{};var that=gis.ui.control(spec,my);that.init=function(){my.control=L.control.locate(my.options);};that.CLASS_NAME="gis.ui.control.locate";return that;};gis.ui.control.polylineMeasure=function(spec,my){my=my||{};var that=gis.ui.control(spec,my);my.options=spec.options||{showMeasurementsClearControl:true};that.init=function(){my.control=L.control.polylineMeasure(my.options);};that.CLASS_NAME="gis.ui.control.polylineMeasure";return that;};gis.ui.control.easyPrint=function(spec,my){my=my||{};var that=gis.ui.control(spec,my);my.options=spec.options||{elementsToHide:['a','button','.leaflet-small-widget','.leaflet-control-coordinates','.leaflet-control-attribution','.leaflet-iconLayers-layer']};that.init=function(){my.control=L.easyPrint(my.options);};that.CLASS_NAME="gis.ui.control.easyPrint";return that;};gis.ui.layerLoader=function(spec,my){var that={};my=my||{};my.map=spec.map;my.defineurl=spec.defineurl;my.baseMaps=[];my.overlays={};my.wmssource=L.WMS.Source.extend({'ajax':function(url,callback){$.ajax(url,{'context':this,'success':function(result){callback.call(this,result);}});},'showFeatureInfo':function(latlng,info){if(!this._map){return;}
if(info&&info.length===0){return;}
var html="";for(var i in info.features){var f=info.features[i];for(var name in f.properties){var val=f.properties[name];if(!val){val="";}
html+="<tr><th>"+name+"</th><td>"+val+"</td></tr>"}}
if(html===""){return;}
html="<table class='popup-table-wms-getfeatureinfo'>"+html+"</table>";this._map.openPopup(html,latlng);}});my.legends=[];my.addLegend=function(legend,title){if(legend){my.legends.push({title:title,elements:legend.elements});}};my.setLayerControl=function(e,layer,name){if(e.isBaseLayer&&e.isBaseLayer===true){my.baseMaps.push({title:name,layer:layer,icon:e.icon});}else{if(!e.group){my.overlays[name]=layer;}else{if(!my.overlays[e.group]){my.overlays[e.group]={};}
my.overlays[e.group][name]=layer;}}
if(e.visible===true){my.map.addLayer(layer);}else{my.map.removeLayer(layer);}};my.createLayer=function(e){if(e.type==="WMS"){var _layer=L.tileLayer.wms(e.url,e.options);my.addLegend(e.legend,e.name);my.setLayerControl(e,_layer,e.name);}else if(e.type==="WMS_getFeatureInfo"){var source=new my.wmssource(e.url,e.options);for(var i in e.layers){var _layer=source.getLayer(e.layers[i].name);my.addLegend(e.layers[i].legend,e.layers[i].title);my.setLayerControl(e,_layer,e.layers[i].title);}}else if(e.type==="TMS"){var _layer=L.tileLayer(e.url,e.options);my.addLegend(e.legend,e.name);my.setLayerControl(e,_layer,e.name);}else if(e.type==="WMTS"){var _layer=new L.TileLayer.WMTS(e.url,e.options);my.addLegend(e.legend,e.name);my.setLayerControl(e,_layer,e.name);}else if(e.type==="GeoJSON"){gis.util.ajaxGetAsync(e.url,function(geojson){var options={onEachFeature:function(feature,layer){if(!feature.properties){return;}
var html="";for(var name in feature.properties){var val=feature.properties[name];if(!val){val="";}
html+="<tr><th>"+name+"</th><td>"+val+"</td></tr>"}
if(html===""){return;}
html="<table class='popup-table-wms-getfeatureinfo'>"+html+"</table>";layer.bindPopup(html);}};if(e.style.type==="icon"){options.pointToLayer=function(feature,latlng){return L.marker(latlng,{icon:L.icon(e.style.options)});};}
var _layer=L.geoJSON(geojson,options);markers=L.markerClusterGroup();markers.addLayer(_layer);my.addLegend(e.legend,e.name);my.setLayerControl(e,markers,e.name);});}};that.init=function(){gis.util.ajaxGetAsync(my.defineurl,function(layers_define){for(var i in layers_define){my.createLayer(layers_define[i]);}
if(my.baseMaps.length>0){var iconLayersControl=new L.Control.IconLayers(my.baseMaps,{position:'bottomleft',maxLayersInRow:5}).addTo(my.map);}
if(my.legends.length>0){var html="<h1>LEGEND</h1>";for(var i in my.legends){var legend=my.legends[i];html+="<hr>"
html+="<h2>"+legend.title+"</h2>";html+=legend.elements[0].html;}
L.control.slideMenu(html,{position:'topright',menuposition:'topright'}).addTo(my.map);}
L.control.groupedLayers({},my.overlays,{exclusiveGroups:["Area"],groupCheckboxes:true}).addTo(my.map);});};that.CLASS_NAME="gis.ui.layerLoader";return that;};gis.ui.dialog.zoomToWss=function(spec,my){my=my||{};var that=gis.ui.dialog(spec,my);my.map=spec.map;my.comboboxPoId='cmbPoId_'+my.dialogId;my.comboboxDistId='cmbDistId_'+my.dialogId;my.comboboxWssId='cmbWssId_'+my.dialogId;my.poid_po_map={};my.distid_dist_map={};my.wssid_wss_map={};my.po_wss_map={};my.dist_wss_map={};my.getHtml=function(){var html="<label for='"+my.comboboxPoId+"'>Private Operator</label><select id='"+my.comboboxPoId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxDistId+"'>District</label><select id='"+my.comboboxDistId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxWssId+"'>WSS</label><select id='"+my.comboboxWssId+"' class='gis-ui-dialog-selectbox'></select>";return html;};my.addOptions=function(option){option.title='Zoom To WSS';option.modal=true;option.resizable=false;option.position={my:"center",at:"center",of:window};return option;};my.getPos=function(){gis.util.ajaxGet('./rest/POs',function(json){if(json.code!==0){alert(json.message);return;}
my.poid_po_map={};var pos=json.value;for(var i in pos){var po=pos[i];my.poid_po_map[po.po_id]=po;}
var no_po={po_id:-1,po_name:"No any operator of WSS"};my.poid_po_map[no_po.po_id]=no_po;$("#"+my.comboboxPoId).append($('<option>').html("Select Private Operator").val(""));for(var po_id in my.poid_po_map){var po=my.poid_po_map[po_id];$("#"+my.comboboxPoId).append($('<option>').html(po.po_name).val(po.po_id));}
$("#"+my.comboboxPoId).change(function(){var po_id=$(this).val();$("#"+my.comboboxWssId+" > option").remove();$("#"+my.comboboxWssId).append($('<option>').html("Select WSS").val(""));$("#"+my.comboboxDistId).val("");if(!my.po_wss_map[po_id]){return;}
for(var wss_id in my.po_wss_map[po_id]){var wss=my.po_wss_map[po_id][wss_id];$("#"+my.comboboxWssId).append($('<option>').html(wss.wss_name).val(wss.wss_id));}});});};my.getDistricts=function(){gis.util.ajaxGet('./rest/Districts/ByWss',function(json){if(json.code!==0){alert(json.message);return;}
my.distid_dist_map={};var districts=json.value;for(var i in districts){var district=districts[i];my.distid_dist_map[district.dist_id]=district;}
$("#"+my.comboboxDistId).append($('<option>').html("Select District").val(""));for(var dist_id in my.distid_dist_map){var district=my.distid_dist_map[dist_id];$("#"+my.comboboxDistId).append($('<option>').html(district.district).val(district.dist_id));}
$("#"+my.comboboxDistId).change(function(){var dist_id=$(this).val();$("#"+my.comboboxWssId+" > option").remove();$("#"+my.comboboxWssId).append($('<option>').html("Select WSS").val(""));$("#"+my.comboboxPoId).val("");if(!my.dist_wss_map[dist_id]){return;}
for(var wss_id in my.dist_wss_map[dist_id]){var wss=my.dist_wss_map[dist_id][wss_id];$("#"+my.comboboxWssId).append($('<option>').html(wss.wss_name).val(wss.wss_id));}
var district=my.distid_dist_map[dist_id];my.set_bounds(district);});});};my.getWSSs=function(){gis.util.ajaxGet('./rest/WSS',function(json){if(json.code!==0){alert(json.message);return;}
my.wssid_wss_map={};my.dist_wss_map={};var wsss=json.value;for(var i in wsss){var wss=wsss[i];if(!my.po_wss_map[wss.po_id]){my.po_wss_map[wss.po_id]=[];}
my.po_wss_map[wss.po_id].push(wss);if(!my.dist_wss_map[wss.dist_id]){my.dist_wss_map[wss.dist_id]=[];}
my.dist_wss_map[wss.dist_id].push(wss);my.wssid_wss_map[wss.wss_id]=wss;}
$("#"+my.comboboxWssId).change(function(){var wss_id=$(this).val();if(wss_id==""){return;}
var wss=my.wssid_wss_map[wss_id];my.set_bounds(wss);that.close();});});};my.postCreate=function(){my.getPos();my.getDistricts();my.getWSSs();};that.CLASS_NAME="gis.ui.dialog.zoomToWss";return that;};gis.ui.control.coordinates=function(spec,my){my=my||{};var that=gis.ui.control(spec,my);my.options=spec.options||{position:"bottomright",decimals:6,labelTemplateLat:"Latitude: {y}",labelTemplateLng:"Longitude: {x}",};my.notRequireSP=spec.notRequireSP||true;that.init=function(){my.control=L.control.coordinates(my.options);};that.CLASS_NAME="gis.ui.control.coordinates";return that;};gis.ui.dialog.zoomToAdmin=function(spec,my){my=my||{};var that=gis.ui.dialog(spec,my);my.map=spec.map;my.comboboxProvId='cmbProvId_'+my.dialogId;my.comboboxDistId='cmbDistId_'+my.dialogId;my.comboboxSectorId='cmbSectId_'+my.dialogId;my.comboboxCellId='cmbCellId_'+my.dialogId;my.comboboxVillId='cmbVillId_'+my.dialogId;my.provid_prov_map={};my.distid_dist_map={};my.sectid_sect_map={};my.cellid_cell_map={};my.villid_vill_map={};my.prov_dist_map={};my.dist_sector_map={};my.sect_cell_map={};my.cell_vill_map={};my.selected_bounds=null;my.getHtml=function(){var html="<label for='"+my.comboboxProvId+"'>Province</label><select id='"+my.comboboxProvId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxDistId+"'>District</label><select id='"+my.comboboxDistId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxSectorId+"'>Sector</label><select id='"+my.comboboxSectorId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxCellId+"'>Cell</label><select id='"+my.comboboxCellId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxVillId+"'>Village</label><select id='"+my.comboboxVillId+"' class='gis-ui-dialog-selectbox'></select>";return html;};my.addOptions=function(option){option.title='Zoom To Administrative';option.modal=true;option.resizable=false;option.position={my:"center",at:"center",of:window};return option;};my.getProvinces=function(){gis.util.ajaxGet('./rest/Provinces',function(json){if(json.code!==0){alert(json.message);return;}
my.provid_prov_map={};var provinces=json.value;for(var i in provinces){var province=provinces[i];my.provid_prov_map[province.prov_id]=province;}
$("#"+my.comboboxProvId).append($('<option>').html("Select Province").val(""));for(var prov_id in my.provid_prov_map){var province=my.provid_prov_map[prov_id];$("#"+my.comboboxProvId).append($('<option>').html(province.prov_name).val(province.prov_id));my.provid_prov_map[province.prov_id]=province;}
$("#"+my.comboboxProvId).change(function(){var prov_id=$(this).val();$("#"+my.comboboxDistId+" > option").remove();$("#"+my.comboboxDistId).append($('<option>').html("Select District").val(""));$("#"+my.comboboxSectorId+" > option").remove();$("#"+my.comboboxCellId+" > option").remove();if(prov_id==""){my.set_bounds();return;}
var province=my.provid_prov_map[prov_id];my.set_bounds(province);for(var dist_id in my.prov_dist_map[prov_id]){var district=my.prov_dist_map[prov_id][dist_id];$("#"+my.comboboxDistId).append($('<option>').html(district.district).val(district.dist_id));}});});};my.getDistricts=function(){gis.util.ajaxGet('./rest/Districts',function(json){if(json.code!==0){alert(json.message);return;}
my.distid_dist_map={};my.prov_dist_map={};var districts=json.value;for(var i in districts){var district=districts[i];if(!my.prov_dist_map[district.prov_id]){my.prov_dist_map[district.prov_id]=[];}
my.prov_dist_map[district.prov_id].push(district);my.distid_dist_map[district.dist_id]=district;}
$("#"+my.comboboxDistId).change(function(){var dist_id=$(this).val();$("#"+my.comboboxSectorId+" > option").remove();$("#"+my.comboboxSectorId).append($('<option>').html("Select Sector").val(""));$("#"+my.comboboxCellId+" > option").remove();if(dist_id==""){var province=my.provid_prov_map[prov_id];my.set_bounds(province);return;}
var district=my.distid_dist_map[dist_id];my.set_bounds(district);for(var sect_id in my.dist_sector_map[dist_id]){var sector=my.dist_sector_map[dist_id][sect_id];$("#"+my.comboboxSectorId).append($('<option>').html(sector.sector).val(sector.sect_id));}});});};my.getSectors=function(){gis.util.ajaxGet('./rest/Sectors',function(json){if(json.code!==0){alert(json.message);return;}
my.sectid_sect_map={};my.dist_sector_map={};var sectors=json.value;for(var i in sectors){var sector=sectors[i];if(!my.dist_sector_map[sector.dist_id]){my.dist_sector_map[sector.dist_id]=[];}
my.dist_sector_map[sector.dist_id].push(sector);my.sectid_sect_map[sector.sect_id]=sector;}
$("#"+my.comboboxSectorId).change(function(){var sect_id=$(this).val();$("#"+my.comboboxCellId+" > option").remove();$("#"+my.comboboxCellId).append($('<option>').html("Select Cell").val(""));if(sect_id==""){var district=my.prov_dist_map[prov_id][dist_id];my.set_bounds(district);return;}
var sector=my.sectid_sect_map[sect_id];my.set_bounds(sector);for(var cell_id in my.sect_cell_map[sect_id]){var cell=my.sect_cell_map[sect_id][cell_id];$("#"+my.comboboxCellId).append($('<option>').html(cell.cell).val(cell.cell_id));}});});};my.getCells=function(){gis.util.ajaxGet('./rest/Cells',function(json){if(json.code!==0){alert(json.message);return;}
my.cellid_cell_map={};my.sect_cell_map={};var cells=json.value;for(var i in cells){var cell=cells[i];if(!my.sect_cell_map[cell.sect_id]){my.sect_cell_map[cell.sect_id]=[];}
my.sect_cell_map[cell.sect_id].push(cell);my.cellid_cell_map[cell.cell_id]=cell;}
$("#"+my.comboboxCellId).change(function(){var cell_id=$(this).val();$("#"+my.comboboxVillId+" > option").remove();$("#"+my.comboboxVillId).append($('<option>').html("Select Village").val(""));if(cell_id==""){var sector=my.dist_sector_map[dist_id][sect_id];my.set_bounds(sector);return;}
var cell=my.cellid_cell_map[cell_id];my.set_bounds(cell);for(var vill_id in my.cell_vill_map[cell_id]){var vill=my.cell_vill_map[cell_id][vill_id];$("#"+my.comboboxVillId).append($('<option>').html(vill.village).val(vill.vill_id));}});});};my.getVillages=function(){gis.util.ajaxGet('./rest/Villages',function(json){if(json.code!==0){alert(json.message);return;}
my.villid_vill_map={};my.cell_vill_map={};var villages=json.value;for(var i in villages){var vill=villages[i];if(!my.cell_vill_map[vill.cell_id]){my.cell_vill_map[vill.cell_id]=[];}
my.cell_vill_map[vill.cell_id].push(vill);my.villid_vill_map[vill.vill_id]=vill;}
$("#"+my.comboboxVillId).change(function(){var vill_id=$(this).val();if(vill_id==""){var cell=my.sector_cell_map[sect_id][cell_id];my.set_bounds(cell);return;}
var vill=my.villid_vill_map[vill_id];my.set_bounds(vill);that.close();});});};my.postCreate=function(){my.getProvinces();my.getDistricts();my.getSectors();my.getCells();my.getVillages();};that.CLASS_NAME="gis.ui.dialog.zoomToAdmin";return that;};gis.util=function(spec,my){var that={};my=my||{};that.CLASS_NAME="gis.util";return that;};gis.util.ajaxGet=function(url,callback){gis.util.ajax(url,'GET',callback);};gis.util.ajaxGetAsync=function(url,callback){gis.util.ajax(url,'GET',callback,null,false);};gis.util.ajaxPut=function(url,callback,data){gis.util.ajax(url,'PUT',callback,data);};gis.util.ajaxDelete=function(url,callback){gis.util.ajax(url,'DELETE',callback);};gis.util.ajax=function(url,type,callback,data,async){$.ajax({url:url,type:type,data:data,dataType:'json',async:async}).done(callback).fail(function(xhr){console.log(xhr.status+';'+xhr.statusText);return false;});};gis.util.isSmartphone=function(){var isSmartPhone=false;var ua=navigator.userAgent;if(ua.indexOf('iPhone')>0||ua.indexOf('iPod')>0||ua.indexOf('Android')>0&&ua.indexOf('Mobile')>0){isSmartPhone=true;}else if(ua.indexOf('iPad')>0||ua.indexOf('Android')>0){isSmartPhone=true;}else{isSmartPhone=false;}
return isSmartPhone;};gis.ui.control.zoomToAreas=function(spec,my){my=my||{};var that=gis.ui.control(spec,my);that.init=function(){my.dialogWss=gis.ui.dialog.zoomToWss({divid:"dialogZoomToWss",map:my.map});my.dialogWss.create();my.dialogAdmin=gis.ui.dialog.zoomToAdmin({divid:"dialogZoomToAdmin",map:my.map});my.dialogAdmin.create();my.control=L.easyBar([L.easyButton('fa-tint',function(){my.dialogWss.open();},'Zoom To WSS'),L.easyButton('fa-sitemap',function(){my.dialogAdmin.open();},'Zoom To Administrative Boundary')]);};that.CLASS_NAME="gis.ui.control.zoomToAreas";return that;};gis.ui.control.geocoder=function(spec,my){my=my||{};var that=gis.ui.control(spec,my);that.init=function(){my.control=L.Control.geocoder(my.options);};that.CLASS_NAME="gis.ui.control.geocoder";return that;};