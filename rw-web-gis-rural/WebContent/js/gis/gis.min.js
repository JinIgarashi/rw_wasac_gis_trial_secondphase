/*
  gis.js -- Web GIS Library
  Copyright 2017 Jin Igarashi All Right Reserved.
*/
var gis={VERSION_NUMBER:"Release 1.0",singleFile:true,_getScriptLocation:(function(){var r=new RegExp("(^|(.*?\\/))(gis[^\\/]*?\\.js)(\\?|$)"),s=document.getElementsByTagName('script'),src,m,l="";for(var i=0,len=s.length;i<len;i++){src=s[i].getAttribute('src');if(src){m=src.match(r);if(m){l=m[1];break;};};};return(function(){return l;});})()};gis.ui=function(spec,my){var that={};my=my||{};my.divid=spec.divid;that.CLASS_NAME="gis.ui";return that;};gis.ui.dialog=function(spec,my){my=my||{};var that=gis.ui(spec,my);my.divid=spec.divid;my.dialogId=spec.divid+'-dialog';my.isInit=false;my.getHtml=function(){return"";};my.beforeOpen=function(){};my.postCreate=function(){};my.addOptions=function(option){return option;};my.set_bounds=function(object){if(!object){my.selected_bounds=null;};my.selected_bounds=[[object.ymin,object.xmin],[object.ymax,object.xmax]];my.map.flyToBounds(my.selected_bounds);};that.create=function(option){option=option||{};if(my.isInit===true){return;};$(document.body).append("<div id='"+my.dialogId+"'></div>");$("#"+my.dialogId).html(my.getHtml());option=my.addOptions(option);if(!option){option={};};if(!option.autoOpen){option.autoOpen=false;};if(!option.modal){option.modal=false;};if(!option.position){option.position=[0,0];};$("#"+my.dialogId).dialog(option);my.postCreate();};that.open=function(){$("#"+my.dialogId).dialog('open');};that.close=function(){$("#"+my.dialogId).dialog('close');};that.CLASS_NAME="gis.ui.dialog";return that;};gis.ui.dialog.zoomToAdmin=function(spec,my){my=my||{};var that=gis.ui.dialog(spec,my);my.map=spec.map;my.comboboxProvId='cmbProvId_'+my.dialogId;my.comboboxDistId='cmbDistId_'+my.dialogId;my.comboboxSectorId='cmbSectId_'+my.dialogId;my.comboboxCellId='cmbCellId_'+my.dialogId;my.comboboxVillId='cmbVillId_'+my.dialogId;my.provid_prov_map={};my.distid_dist_map={};my.sectid_sect_map={};my.cellid_cell_map={};my.villid_vill_map={};my.prov_dist_map={};my.dist_sector_map={};my.sect_cell_map={};my.cell_vill_map={};my.selected_bounds=null;my.getHtml=function(){var html="<label for='"+my.comboboxProvId+"'>Province</label><select id='"+my.comboboxProvId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxDistId+"'>District</label><select id='"+my.comboboxDistId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxSectorId+"'>Sector</label><select id='"+my.comboboxSectorId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxCellId+"'>Cell</label><select id='"+my.comboboxCellId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxVillId+"'>Village</label><select id='"+my.comboboxVillId+"' class='gis-ui-dialog-selectbox'></select>";return html;};my.addOptions=function(option){option.title='Zoom To Administrative';option.modal=true;option.resizable=false;option.position={my:"center",at:"center",of:window};return option;};my.getProvinces=function(){gis.util.ajaxGet('./rest/Provinces',function(json){if(json.code!==0){alert(json.message);return;};my.provid_prov_map={};var provinces=json.value;for(var i in provinces){var province=provinces[i];my.provid_prov_map[province.prov_id]=province;};$("#"+my.comboboxProvId).append($('<option>').html("Select Province").val(""));for(var prov_id in my.provid_prov_map){var province=my.provid_prov_map[prov_id];$("#"+my.comboboxProvId).append($('<option>').html(province.prov_name).val(province.prov_id));my.provid_prov_map[province.prov_id]=province;};$("#"+my.comboboxProvId).change(function(){var prov_id=$(this).val();$("#"+my.comboboxDistId+" > option").remove();$("#"+my.comboboxDistId).append($('<option>').html("Select District").val(""));$("#"+my.comboboxSectorId+" > option").remove();$("#"+my.comboboxCellId+" > option").remove();if(prov_id==""){my.set_bounds();return;};var province=my.provid_prov_map[prov_id];my.set_bounds(province);for(var dist_id in my.prov_dist_map[prov_id]){var district=my.prov_dist_map[prov_id][dist_id];$("#"+my.comboboxDistId).append($('<option>').html(district.district).val(district.dist_id));};});});};my.getDistricts=function(){gis.util.ajaxGet('./rest/Districts',function(json){if(json.code!==0){alert(json.message);return;};my.distid_dist_map={};my.prov_dist_map={};var districts=json.value;for(var i in districts){var district=districts[i];if(!my.prov_dist_map[district.prov_id]){my.prov_dist_map[district.prov_id]=[];};my.prov_dist_map[district.prov_id].push(district);my.distid_dist_map[district.dist_id]=district;};$("#"+my.comboboxDistId).change(function(){var dist_id=$(this).val();$("#"+my.comboboxSectorId+" > option").remove();$("#"+my.comboboxSectorId).append($('<option>').html("Select Sector").val(""));$("#"+my.comboboxCellId+" > option").remove();if(dist_id==""){var province=my.provid_prov_map[prov_id];my.set_bounds(province);return;};var district=my.distid_dist_map[dist_id];my.set_bounds(district);for(var sect_id in my.dist_sector_map[dist_id]){var sector=my.dist_sector_map[dist_id][sect_id];$("#"+my.comboboxSectorId).append($('<option>').html(sector.sector).val(sector.sect_id));};});});};my.getSectors=function(){gis.util.ajaxGet('./rest/Sectors',function(json){if(json.code!==0){alert(json.message);return;};my.sectid_sect_map={};my.dist_sector_map={};var sectors=json.value;for(var i in sectors){var sector=sectors[i];if(!my.dist_sector_map[sector.dist_id]){my.dist_sector_map[sector.dist_id]=[];};my.dist_sector_map[sector.dist_id].push(sector);my.sectid_sect_map[sector.sect_id]=sector;};$("#"+my.comboboxSectorId).change(function(){var sect_id=$(this).val();$("#"+my.comboboxCellId+" > option").remove();$("#"+my.comboboxCellId).append($('<option>').html("Select Cell").val(""));if(sect_id==""){var district=my.prov_dist_map[prov_id][dist_id];my.set_bounds(district);return;};var sector=my.sectid_sect_map[sect_id];my.set_bounds(sector);for(var cell_id in my.sect_cell_map[sect_id]){var cell=my.sect_cell_map[sect_id][cell_id];$("#"+my.comboboxCellId).append($('<option>').html(cell.cell).val(cell.cell_id));};});});};my.getCells=function(){gis.util.ajaxGet('./rest/Cells',function(json){if(json.code!==0){alert(json.message);return;};my.cellid_cell_map={};my.sect_cell_map={};var cells=json.value;for(var i in cells){var cell=cells[i];if(!my.sect_cell_map[cell.sect_id]){my.sect_cell_map[cell.sect_id]=[];};my.sect_cell_map[cell.sect_id].push(cell);my.cellid_cell_map[cell.cell_id]=cell;};$("#"+my.comboboxCellId).change(function(){var cell_id=$(this).val();$("#"+my.comboboxVillId+" > option").remove();$("#"+my.comboboxVillId).append($('<option>').html("Select Village").val(""));if(cell_id==""){var sector=my.dist_sector_map[dist_id][sect_id];my.set_bounds(sector);return;};var cell=my.cellid_cell_map[cell_id];my.set_bounds(cell);for(var vill_id in my.cell_vill_map[cell_id]){var vill=my.cell_vill_map[cell_id][vill_id];$("#"+my.comboboxVillId).append($('<option>').html(vill.village).val(vill.vill_id));};});});};my.getVillages=function(){gis.util.ajaxGet('./rest/Villages',function(json){if(json.code!==0){alert(json.message);return;};my.villid_vill_map={};my.cell_vill_map={};var villages=json.value;for(var i in villages){var vill=villages[i];if(!my.cell_vill_map[vill.cell_id]){my.cell_vill_map[vill.cell_id]=[];};my.cell_vill_map[vill.cell_id].push(vill);my.villid_vill_map[vill.vill_id]=vill;};$("#"+my.comboboxVillId).change(function(){var vill_id=$(this).val();if(vill_id==""){var cell=my.sector_cell_map[sect_id][cell_id];my.set_bounds(cell);return;};var vill=my.villid_vill_map[vill_id];my.set_bounds(vill);that.close();});});};my.postCreate=function(){my.getProvinces();my.getDistricts();my.getSectors();my.getCells();my.getVillages();};that.CLASS_NAME="gis.ui.dialog.zoomToAdmin";return that;};gis.ui.layerLoader=function(spec,my){var that={};my=my||{};my.map=spec.map;my.defineurl=spec.defineurl;my.controlLoader=spec.controlLoader||null;my.baseMaps=[];my.setLayerControl=function(e,layer,title){if(e.isBaseLayer&&e.isBaseLayer===true){my.baseMaps.push({title:title,layer:layer,icon:e.icon});}else{if(e.legend){title+="<br><div style='width:100%'>"+e.legend.elements[0].html+"</div><hr>";};my.layerControl.addOverlay(layer,title,{groupName:e.group});};if(e.visible===true){my.map.addLayer(layer);}else{my.map.removeLayer(layer);};};my.createLayer=function(e){switch(e.type){case'WMS':var _layer=L.tileLayer.wms(e.url,e.options);my.setLayerControl(e,_layer,e.name);break;case'WMS_getFeatureInfo':var source=new L.WMS.Source(e.url,e.options);for(var i in e.layers){var _layer=source.getLayer(e.layers[i].name);my.setLayerControl(e,_layer,e.layers[i].title);};break;case'TMS':var _layer=L.tileLayer(e.url,e.options);my.setLayerControl(e,_layer,e.name);break;case'WMTS':var _layer=new L.TileLayer.WMTS(e.url,e.options);my.setLayerControl(e,_layer,e.name);break;case'GeoJSON':var _layer=my.createGeoJSON(e);my.setLayerControl(e,_layer,e.name);break;case'WFS':e.options.crs=L.CRS[e.options.crs];var _layer=new L.WFST(e.options);_layer.on({'click':function(e){my.create_profile(e.layer);}});my.setLayerControl(e,_layer,e.name);default:break;};};my.create_profile=function(layer){var latlngs=layer._latlngs;if(latlngs.length===0){return;};var coords=latlngs[0];if(coords.length===0){return;}
var wkt="";for(var i in coords){var coord=coords[i];if(i>0){wkt+=",";};wkt+=coord.lng+" "+coord.lat;};wkt="LineString("+wkt+")";var params={wkt:wkt};gis.util.ajaxPut('./rest/Elevation/LineString',getLineWithElevation,params);function getLineWithElevation(json){var geojson={"name":"NewFeatureType","type":"FeatureCollection","features":[{"type":"Feature","geometry":json}]};if(!my.controlLoader){return;}
var el=my.controlLoader.getControl('elevation');if(!el){return;}
el.clear();el._expand();if(my.elevjson){my.map.removeLayer(my.elevjson);my.elevjson=null;};my.elevjson=L.geoJson(geojson,{onEachFeature:el.addData.bind(el)}).addTo(my.map);}},my.createGeoJSON=function(e){var options={onEachFeature:function(feature,layer){if(!feature.properties){return;};var html="";for(var name in feature.properties){var val=feature.properties[name];if(!val){val="";};html+="<tr><th>"+name+"</th><td>"+val+"</td></tr>"};if(html===""){return;};html="<table class='leaflet-tilelayer-wmts-getfeatureinfo'>"+html+"</table>";var popup=L.responsivePopup({offset:[40,40],autoPanPadding:[40,40]}).setContent(html);layer.bindPopup(popup);}};if(e.style.type==="icon"){options.pointToLayer=function(feature,latlng){return L.marker(latlng,{icon:L.icon(e.style.options)});};};var _layer=new L.GeoJSON.AJAX(e.url,options);if(!my.mcgroup){my.mcgroup=L.markerClusterGroup();my.mcgroup.addTo(my.map);};var markers=L.featureGroup.subGroup(my.mcgroup);markers.addLayer(_layer);markers.addTo(my.map);return markers;};that.init=function(){gis.util.ajaxGetAsync(my.defineurl,function(layers_define){my.layerControl=L.Control.styledLayerControl({},my.overlays,{container_width:"300px",group_maxHeight:"90%",exclusive:false,group_togglers:{show:true,labelAll:'Select All',labelNone:'Deselect All'},}).addTo(my.map);for(var i in layers_define){my.createLayer(layers_define[i]);};if(my.baseMaps.length>0){var iconLayersControl=new L.Control.IconLayers(my.baseMaps,{position:'bottomleft',maxLayersInRow:5}).addTo(my.map);};});return that;};that.CLASS_NAME="gis.ui.layerLoader";return that;};gis.ui.dialog.zoomToWss=function(spec,my){my=my||{};var that=gis.ui.dialog(spec,my);my.map=spec.map;my.comboboxPoId='cmbPoId_'+my.dialogId;my.comboboxDistId='cmbDistId_'+my.dialogId;my.comboboxWssId='cmbWssId_'+my.dialogId;my.poid_po_map={};my.distid_dist_map={};my.wssid_wss_map={};my.po_wss_map={};my.dist_wss_map={};my.getHtml=function(){var html="<label for='"+my.comboboxPoId+"'>Private Operator</label><select id='"+my.comboboxPoId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxDistId+"'>District</label><select id='"+my.comboboxDistId+"' class='gis-ui-dialog-selectbox'></select>"+"<br>"+"<label for='"+my.comboboxWssId+"'>WSS</label><select id='"+my.comboboxWssId+"' class='gis-ui-dialog-selectbox'></select>";return html;};my.addOptions=function(option){option.title='Zoom To WSS';option.modal=true;option.resizable=false;option.position={my:"center",at:"center",of:window};return option;};my.getPos=function(){gis.util.ajaxGet('./rest/POs',function(json){if(json.code!==0){alert(json.message);return;};my.poid_po_map={};var pos=json.value;for(var i in pos){var po=pos[i];my.poid_po_map[po.po_id]=po;};var no_po={po_id:-1,po_name:"No any operator of WSS"};my.poid_po_map[no_po.po_id]=no_po;$("#"+my.comboboxPoId).append($('<option>').html("Select Private Operator").val(""));for(var po_id in my.poid_po_map){var po=my.poid_po_map[po_id];$("#"+my.comboboxPoId).append($('<option>').html(po.po_name).val(po.po_id));};$("#"+my.comboboxPoId).change(function(){var po_id=$(this).val();$("#"+my.comboboxWssId+" > option").remove();$("#"+my.comboboxWssId).append($('<option>').html("Select WSS").val(""));$("#"+my.comboboxDistId).val("");if(!my.po_wss_map[po_id]){return;};for(var wss_id in my.po_wss_map[po_id]){var wss=my.po_wss_map[po_id][wss_id];$("#"+my.comboboxWssId).append($('<option>').html(wss.wss_name).val(wss.wss_id));};});});};my.getDistricts=function(){gis.util.ajaxGet('./rest/Districts/ByWss',function(json){if(json.code!==0){alert(json.message);return;};my.distid_dist_map={};var districts=json.value;for(var i in districts){var district=districts[i];my.distid_dist_map[district.dist_id]=district;};$("#"+my.comboboxDistId).append($('<option>').html("Select District").val(""));for(var dist_id in my.distid_dist_map){var district=my.distid_dist_map[dist_id];$("#"+my.comboboxDistId).append($('<option>').html(district.district).val(district.dist_id));};$("#"+my.comboboxDistId).change(function(){var dist_id=$(this).val();$("#"+my.comboboxWssId+" > option").remove();$("#"+my.comboboxWssId).append($('<option>').html("Select WSS").val(""));$("#"+my.comboboxPoId).val("");if(!my.dist_wss_map[dist_id]){return;};for(var wss_id in my.dist_wss_map[dist_id]){var wss=my.dist_wss_map[dist_id][wss_id];$("#"+my.comboboxWssId).append($('<option>').html(wss.wss_name).val(wss.wss_id));};var district=my.distid_dist_map[dist_id];my.set_bounds(district);});});};my.getWSSs=function(){gis.util.ajaxGet('./rest/WSS',function(json){if(json.code!==0){alert(json.message);return;};my.wssid_wss_map={};my.dist_wss_map={};var wsss=json.value;for(var i in wsss){var wss=wsss[i];if(!my.po_wss_map[wss.po_id]){my.po_wss_map[wss.po_id]=[];};my.po_wss_map[wss.po_id].push(wss);if(!my.dist_wss_map[wss.dist_id]){my.dist_wss_map[wss.dist_id]=[];};my.dist_wss_map[wss.dist_id].push(wss);my.wssid_wss_map[wss.wss_id]=wss;};$("#"+my.comboboxWssId).change(function(){var wss_id=$(this).val();if(wss_id==""){return;};var wss=my.wssid_wss_map[wss_id];my.set_bounds(wss);that.close();});});};my.postCreate=function(){my.getPos();my.getDistricts();my.getWSSs();};that.CLASS_NAME="gis.ui.dialog.zoomToWss";return that;};gis.ui.controlLoader=function(spec,my){var that={};my=my||{};my.map=spec.map;my.defineurl=spec.defineurl;my.controlMap={};my.getControl=function(ctrltype,options){switch(ctrltype){case'bookmarks':ctrl=my.createBookmarks(options);break;case'easyPrint':ctrl=L.easyPrint(options);break;case'geocoder':ctrl=L.Control.geocoder(options);break;case'graphicScale':ctrl=L.control.graphicScale(options);break;case'locate':ctrl=L.control.locate(options);break;case'navbar':ctrl=L.control.navbar(options);break;case'polylineMeasure':if(!L.Browser.mobile){options.measure_addpoint=my.measure_addpoint;options.measure_cleared=my.measure_cleared;};ctrl=L.control.polylineMeasure(options);break;case'zoomToAreas':ctrl=my.createZoomToArea(options);break;case'elevation':ctrl=L.control.elevation(options);break;};if(ctrl){my.controlMap[ctrltype]=ctrl;}
return ctrl;};my.createBookmarks=function(options){options.storage={getItem:function(id,callback){gis.util.ajaxGet('./rest/Bookmarks/'+id,callback);},setItem:function(id,value,callback){gis.util.ajaxPut('./rest/Bookmarks/'+id,callback,value);},removeItem:function(id,callback){gis.util.ajaxDelete('./rest/Bookmarks/'+id,callback);},getAllItems:function(callback){gis.util.ajaxGet('./rest/Bookmarks/',callback);}};return new L.Control.Bookmarks(options);};my.createZoomToArea=function(options){my.dialogWss=gis.ui.dialog.zoomToWss({divid:"dialogZoomToWss",map:my.map});my.dialogWss.create();my.dialogAdmin=gis.ui.dialog.zoomToAdmin({divid:"dialogZoomToAdmin",map:my.map});my.dialogAdmin.create();my.dialogEpanet=gis.ui.dialog.epanet({divid:"dialogEpanet",map:my.map});my.dialogEpanet.create();return L.easyBar([L.easyButton('fa-tint',function(){my.dialogWss.open();},'Zoom To WSS'),L.easyButton('fa-sitemap',function(){my.dialogAdmin.open();},'Zoom To Administrative Boundary'),L.easyButton('fa-download',function(){my.dialogEpanet.open();},'Download Epanet File')],options);};my.measure_addpoint=function(e){var coordinates=e.polylinePath._latlngs;if(coordinates.length===0){return;};var wkt="";for(var i in coordinates){var coord=coordinates[i];if(i>0){wkt+=",";};wkt+=coord.lng+" "+coord.lat;};wkt="LineString("+wkt+")";var params={wkt:wkt};gis.util.ajaxPut('./rest/Elevation/LineString',getLineWithElevation,params);function getLineWithElevation(json){var geojson={"name":"NewFeatureType","type":"FeatureCollection","features":[{"type":"Feature","geometry":json}]};var el=my.controlMap['elevation'];el.clear();el._expand();if(my.elevjson){my.map.removeLayer(my.elevjson);my.elevjson=null;};my.elevjson=L.geoJson(geojson,{onEachFeature:el.addData.bind(el)}).addTo(my.map);}},my.measure_cleared=function(e){var el=my.controlMap['elevation'];el.clear();if(my.elevjson){my.map.removeLayer(my.elevjson);my.elevjson=null;};};that.init=function(){gis.util.ajaxGet(my.defineurl,function(ctrls_define){var settings={map:my.map};for(var i in ctrls_define){for(var j in ctrls_define[i].settings){settings[j]=ctrls_define[i].settings[j];};if(L.Browser.mobile&&settings.notRequireSP==true){continue;};var ctrl=my.getControl(ctrls_define[i].ctrl,settings.options);if(!ctrl){continue;};ctrl.addTo(my.map);};});return that;};that.getControl=function(name){return my.controlMap[name];};that.CLASS_NAME="gis.ui.controlLoader";return that;};gis.util=function(spec,my){var that={};my=my||{};that.CLASS_NAME="gis.util";return that;};gis.util.ajaxGet=function(url,callback,dataType){gis.util.ajax(url,'GET',callback,null,dataType);};gis.util.ajaxGetAsync=function(url,callback,dataType){gis.util.ajax(url,'GET',callback,null,dataType,false);};gis.util.ajaxPut=function(url,callback,data){gis.util.ajax(url,'PUT',callback,data);};gis.util.ajaxDelete=function(url,callback){gis.util.ajax(url,'DELETE',callback);};gis.util.ajax=function(url,type,callback,data,dataType,async){if(!dataType){dataType='json';};$.ajax({url:url,type:type,data:data,dataType:dataType,async:async}).done(callback).fail(function(xhr){console.log(xhr.status+';'+xhr.statusText);return false;});};gis.util.ajaxGetFile=function(url){$.ajax({url:url,type:'GET'}).done((data,status,jqXHR)=>{let downloadData=new Blob([data],{type:'text/csv'});let filename='epanet.inp'
if(window.navigator.msSaveBlob){window.navigator.msSaveBlob(downloadData,filename);}else{let downloadUrl=(window.URL||window.webkitURL).createObjectURL(downloadData);let link=document.createElement('a');link.href=downloadUrl;link.download=filename;link.click();(window.URL||window.webkitURL).revokeObjectURL(downloadUrl);}}).fail((data,status,jqXHR)=>{alert('It failed to download EPANET file.');});};gis.ui.dialog.epanet=function(spec,my){my=my||{};var that=gis.ui.dialog.zoomToWss(spec,my);my.addOptions=function(option){option.title='Download EPANET';option.modal=true;option.resizable=false;option.position={my:"center",at:"center",of:window};option.buttons=[{text:"Download",click:function(){var wss_id=$("#"+my.comboboxWssId).val();if(wss_id===""){return;}
gis.util.ajaxGetFile('./rest/Epanet?wss_id='+wss_id);}}]
return option;};my.getWSSs=function(){gis.util.ajaxGet('./rest/WSS',function(json){if(json.code!==0){alert(json.message);return;};my.wssid_wss_map={};my.dist_wss_map={};var wsss=json.value;for(var i in wsss){var wss=wsss[i];if(!my.po_wss_map[wss.po_id]){my.po_wss_map[wss.po_id]=[];};my.po_wss_map[wss.po_id].push(wss);if(!my.dist_wss_map[wss.dist_id]){my.dist_wss_map[wss.dist_id]=[];};my.dist_wss_map[wss.dist_id].push(wss);my.wssid_wss_map[wss.wss_id]=wss;};$("#"+my.comboboxWssId).change(function(){var wss_id=$(this).val();if(wss_id==""){return;};var wss=my.wssid_wss_map[wss_id];my.set_bounds(wss);});});};that.CLASS_NAME="gis.ui.dialog.zoomToWss";return that;};